<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý nội dung trang - Shoes Shop Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        body { background: #f5f7fa; font-family: 'Segoe UI', sans-serif; padding-bottom: 50px; }
        .page-title { color: #2c3e50; font-weight: 700; }
        .card-page {
            cursor: pointer; transition: all 0.3s ease; border: 2px solid #e9ecef;
            height: 100%; border-radius: 12px; overflow: hidden;
        }
        .card-page:hover {
            transform: translateY(-8px); box-shadow: 0 12px 25px rgba(0,0,0,0.15);
            border-color: #0d6efd;
        }
        .preview-img {
            width: 100%; height: 200px; object-fit: cover;
        }
        #editSection { border-radius: 12px; }
        #previewImage { max-height: 400px; border-radius: 10px; }
    </style>
</head>
<body class="p-4">

<div class="container-fluid">
    <h2 class="page-title mb-5 text-center">QUẢN LÝ NỘI DUNG CÁC TRANG</h2>

    <div class="row row-cols-1 row-cols-md-3 g-4" id="pagesList"></div>

    <div class="card shadow-lg mt-5 d-none" id="editSection">
        <div class="card-header bg-gradient bg-primary text-white py-4">
            <h4 class="mb-0 text-center">
                Chỉnh sửa trang: <strong id="editingPage">HOME</strong>
            </h4>
        </div>
        <div class="card-body p-5">
            <form id="editForm">
                <div class="row g-4">
                    <div class="col-lg-8">
                        <label class="form-label fw-bold fs-5">Tiêu đề trang</label>
                        <input type="text" class="form-control form-control-lg" id="editTitle" required>

                        <label class="form-label fw-bold fs-5 mt-4">Nội dung HTML</label>
                        <textarea class="form-control" id="editContent" rows="18" required></textarea>
                    </div>
                    <div class="col-lg-4">
                        <label class="form-label fw-bold fs-5">Link hình ảnh chính</label>
                        <input type="url" class="form-control form-control-lg" id="editImage" placeholder="https://...">
                        
                        <div class="text-center mt-3">
                            <img id="previewImage" src="" class="img-fluid rounded shadow" style="display:none;">
                            <p class="text-muted mt-3" id="noImageText">Chưa có hình ảnh</p>
                        </div>
                    </div>
                </div>

                <hr class="my-5">
                <div class="text-end">
                    <button type="button" class="btn btn-secondary btn-lg px-4" onclick="cancelEdit()">Hủy</button>
                    <button type="submit" class="btn btn-success btn-lg px-5">
                        Lưu thay đổi
                    </button>
                </div>
                <input type="hidden" id="editId">
            </form>
        </div>
    </div>
</div>

<script>
// Danh sách trang bạn muốn quản lý
const pages = ['home', 'about', 'policy', 'contact', 'shipping', 'warranty', 'payment', 'faq'];

async function loadAllPages() {
    const container = document.getElementById('pagesList');
    container.innerHTML = `<div class="col-12 text-center py-5"><div class="spinner-border text-primary" style="width:3rem;height:3rem;"></div></div>`;

    let html = '';
    for (const page of pages) {
        try {
            const res = await fetch(`/Shoes-Shop/api/SiteContent/getPageContent.php?page=${page}&t=${Date.now()}`);
            const json = await res.json();
            const d = json.success && json.data ? json.data : { title: 'Chưa có nội dung', content_html: '', image_url: '', updated_at: null };

            const updateTime = d.updated_at 
                ? new Date(d.updated_at).toLocaleDateString('vi-VN') + ' lúc ' + 
                  new Date(d.updated_at).toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'})
                : 'Chưa cập nhật';

            html += `
            <div class="col">
                <div class="card card-page h-100" onclick="editPage('${page}', ${d.content_id || 'null'})">
                    ${d.image_url ? `<img src="${d.image_url}" class="preview-img" onerror="this.style.display='none'">` : ''}
                    <div class="card-body text-center py-4">
                        <h4 class="text-uppercase text-primary fw-bold">${page}</h4>
                        <p class="fw-medium text-dark">${escape(d.title || 'Chưa có tiêu đề')}</p>
                        <div class="mt-2">
                            <small class="badge bg-${d.content_html ? 'success' : 'secondary'} px-3 py-2">
                                ${d.content_html ? 'Đã có nội dung' : 'Chưa có nội dung'}
                            </small>
                            <br><small class="text-muted mt-1 d-block">${updateTime}</small>
                        </div>
                    </div>
                </div>
            </div>`;
        } catch (e) {
            html += `<div class="col"><div class="card border-danger"><div class="card-body text-danger text-center">Lỗi: ${page}</div></div></div>`;
        }
    }
    container.innerHTML = html;
}

function editPage(page, id) {
    document.getElementById('editingPage').textContent = page.toUpperCase();
    document.getElementById('editId').value = id || '';

    fetch(`/Shoes-Shop/api/SiteContent/getPageContent.php?page=${page}`)
        .then(r => r.json())
        .then(json => {
            const d = json.success && json.data ? json.data : { title: '', content_html: '', image_url: '' };
            document.getElementById('editTitle').value = d.title || '';
            document.getElementById('editContent').value = d.content_html || '';
            document.getElementById('editImage').value = d.image_url || '';

            const img = document.getElementById('previewImage');
            const noImg = document.getElementById('noImageText');
            if (d.image_url) {
                img.src = d.image_url + '?t=' + Date.now();
                img.style.display = 'block';
                noImg.style.display = 'none';
            } else {
                img.style.display = 'none';
                noImg.style.display = 'block';
            }

            document.getElementById('editSection').classList.remove('d-none');
            document.getElementById('editSection').scrollIntoView({ behavior: 'smooth' });
        });
}

function cancelEdit() {
    document.getElementById('editSection').classList.add('d-none');
}

document.getElementById('editForm').onsubmit = async function(e) {
    e.preventDefault();
    
    const data = {
        content_id: document.getElementById('editId').value || null,
        title: document.getElementById('editTitle').value.trim(),
        content_html: document.getElementById('editContent').value,
        image_url: document.getElementById('editImage').value.trim() || null
    };

    const res = await fetch('/Shoes-Shop/api/SiteContent/updatePageContent.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    const json = await res.json();

    if (json.success) {
        alert('Đã lưu thành công trang ' + document.getElementById('editingPage').textContent + '!');
        loadAllPages();
    } else {
        alert('Lỗi: ' + (json.message || 'Không thể lưu'));
    }
};

function escape(t) {
    const div = document.createElement('div');
    div.textContent = t;
    return div.innerHTML;
}

loadAllPages();
</script>
</body>
</html>